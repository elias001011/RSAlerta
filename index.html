<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSAlerta - Monitoramento Climático e Ambiental</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
        }
        .container-card {
            background-color: #ffffff; /* white */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        input, select, textarea {
            background-color: #ffffff;
            color: #1f2937;
            border-color: #d1d5db; /* gray-300 */
        }
        /* Ajustes para garantir que elementos de input/select no tema claro sejam visíveis */
        input::placeholder {
            color: #9ca3af; /* gray-400 */
        }
        select {
            color: #1f2937;
        }
        
        #map { height: 400px; border-radius: 0.75rem; }
        .leaflet-control-layers-toggle {
            background-image: url(data:image/png;base64,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) !important;
            width: 30px !important;
            height: 30px !important;
            background-size: 20px 20px !important;
            background-position: center !important;
            border-radius: 0.375rem !important; /* rounded-md */
        }
        .leaflet-control-layers {
            border-radius: 0.375rem !important; /* rounded-md */
            background: #ffffff !important;
            color: #1f2937 !important;
        }

        #aiChatHistory::-webkit-scrollbar { width: 8px; }
        #aiChatHistory::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; } /* gray-200 */
        #aiChatHistory::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; } /* gray-400 */
        #aiChatHistory::-webkit-scrollbar-thumb:hover { background: #6b7280; } /* gray-500 */
        
        .message-user {
            text-align: right;
            margin-left: auto;
            background-color: #dbeafe; /* blue-100 */
            color: #1e40af; /* blue-800 */
        }
        .message-bot {
            text-align: left;
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
        }
        .message {
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        .loader {
            border: 4px solid #e5e7eb; /* gray-200 */
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos para Indicadores Ambientais */
        .indicator-item {
            background-color: #e0f2fe; /* sky-100 */
            padding: 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            border-left: 5px solid #0ea5e9; /* sky-500 */
        }
        .indicator-item h4 {
            color: #0c4a6e; /* sky-800 */
            font-weight: 600; /* semibold */
        }
        .indicator-item p {
            color: #075985; /* sky-700 */
        }
        .indicator-item .source {
            font-size: 0.75rem; /* text-xs */
            color: #0369a1; /* sky-600 */
            margin-top: 0.5rem;
        }
        .aqi-card {
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        .aqi-1 { background-color: #ccfbf1; color: #0f766e; border-left: 5px solid #14b8a6;} /* teal */
        .aqi-2 { background-color: #fef9c3; color: #a16207; border-left: 5px solid #facc15;} /* yellow */
        .aqi-3 { background-color: #ffedd5; color: #c2410c; border-left: 5px solid #fb923c;} /* orange */
        .aqi-4 { background-color: #fee2e2; color: #b91c1c; border-left: 5px solid #f87171;} /* red */
        .aqi-5 { background-color: #f3e8ff; color: #7e22ce; border-left: 5px solid #a855f7;} /* purple */
        .aqi-unknown { background-color: #e5e7eb; color: #4b5563; border-left: 5px solid #6b7280;} /* gray */

    </style>
</head>
<body class="bg-gray-100">

    <nav id="topNav" class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-3">
                <div class="flex items-center">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiByeD0iOCIgZmlsbD0iIzRFQjQ1QSIvPgo8cGF0aCBkPSJNMjQgNi41QzE0Ljg5MSA2LjUgNy41IDEzLjg5MSA3LjUgMjNDNy41IDMyLjEwOSAxNC44OTEgMzkuNSAyNCAzOS41QzMzLjEwOSAzOS41IDQwLjUgMzIuMTA5IDQwLjUgMjNDNDAuNSAxMy44OTEgMzMuMTA5IDYuNSAyNCA2LjVaTTI0IDM2LjVDMTYuNTM4IDM2LjUgMTAuNSAzMC40NjIgMTAuNSAyM0MxMC41IDE1LjUzOCAxNi41MzggOS41IDI0IDkuNUMzMS40NjIgOS41IDM3LjUgMTUuNTM4IDM3LjUgMjNDMzcuNSAzMC40NjIgMzEuNDYyIDM2LjUgMjQgMzYuNVoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yNC4wMDAxIDEzLjI1QzIwLjQxMDMgMTMuMjUgMTcuNTAwMSAxNi4xNjAyIDE3LjUwMDEgMTkuNzVDMTcuNTAwMSAyMy4zMzk4IDIwLjQxMDMgMjYuMjUgMjQuMDAwMSAyNi4yNUMyNy41ODk5IDI2LjI1IDMwLjUwMDEgMjMuMzM5OCAzMC41MDAxIDE5Ljc1QzMwLjUwMDEgMTYuMTYwMiAyNy41ODk5IDEzLjI1IDI0LjAwMDEgMTMuMjVaTTI0LjAwMDEgMjMuMjVDMjIuMjAxMSAyMy4yNSAyMC43NTAxIDIxLjgwOTEgMjAuNzUwMSAxOS43NUMyMC43NTAxIDE3LjY5MDkgMjIuMjAxMSAxNi4yNSAyNC4wMDAxIDE2LjI1QzI1Ljc5OTEgMTYuMjUgMjcuMjUwMSAxNy42OTA5IDI3LjI1MDEgMTkuNzVDMjcuMjUwMSAyMS44MDkxIDI1Ljc5OTEgMjMuMjUgMjQuMDAwMSAyMy4yNVoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yOC40MjgzIDI1LjQ5OTZMMzIuMDQxMyAzMS41MDA0SDI5LjM1NzFMMjYuNDU4OCAyNi45NDU3TDI0LjAwNzIgMjkuMjVMOC45NTgwMyAzMS41MDA0TDExLjY0MjMgMjUuNDk5NkwxNS4yNTUzIDE5LjQ5ODhIMTcuOTM5NUwxNS4wNDA5IDI0LjA1MjdMMTcuNzMyNSAyMS43NDk2TDI4LjQyODMgMjUuNDk5NloiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0zMi43NjY4IDE2LjVIMzAuMDgyNkwyNC4wMDAxIDI0LjIzMzFMMTcuOTE3NSAxNi41SDE1LjI1MzFMMjQuMDAwMSAyNy4yNUwzMi43NjY4IDE2LjVaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K" alt="RSAlerta Logo" class="h-10 w-10 mr-2">
                    <span class="text-xl font-bold text-gray-800">RSAlerta</span>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <a href="#clima" class="text-gray-600 hover:text-blue-500">Clima</a>
                    <a href="#qualidade_ar_section" class="text-gray-600 hover:text-blue-500">Qualidade do Ar</a>
                    <a href="#mapa" class="text-gray-600 hover:text-blue-500">Mapa</a>
                    <a href="#ia" class="text-gray-600 hover:text-blue-500">Assistente Virtual</a>
                    <a href="#alertas" class="text-gray-600 hover:text-blue-500">Alertas</a>
                    <a href="#links" class="text-gray-600 hover:text-blue-500">Links</a>
                </div>
                <div class="flex items-center">
                    <button id="mobileMenuButton" class="md:hidden ml-3 text-gray-600">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="mobileMenu" class="hidden md:hidden py-2">
                <a href="#clima" class="block px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">Clima</a>
                <a href="#qualidade_ar_section" class="block px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">Qualidade do Ar</a>
                <a href="#mapa" class="block px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">Mapa</a>
                <a href="#ia" class="block px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">Assistente Virtual</a>
                <a href="#alertas" class="block px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">Alertas</a>
                <a href="#links" class="block px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">Links</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 space-y-8">
        <section id="search" class="container-card">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Buscar Clima por Cidade</h2>
            <div class="flex flex-col sm:flex-row gap-2 mb-3">
                <input type="text" id="citySearchInput" placeholder="Digite o nome da cidade" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="searchCityButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out">
                    <i class="fas fa-search mr-2"></i>Pesquisar
                </button>
            </div>
            <div id="searchResults" class="mb-3"></div>
            <div class="flex flex-wrap gap-2">
                <span class="font-medium mr-2">Principais cidades do RS:</span>
                <button class="city-preset-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-full text-sm" data-city="Porto Alegre">Porto Alegre</button>
                <button class="city-preset-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-full text-sm" data-city="Caxias do Sul">Caxias do Sul</button>
                <button class="city-preset-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-full text-sm" data-city="Pelotas">Pelotas</button>
                <button class="city-preset-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-full text-sm" data-city="Santa Maria">Santa Maria</button>
                <button class="city-preset-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-full text-sm" data-city="Sarandi">Sarandi</button>
            </div>
        </section>

        <section id="clima" class="container-card hidden">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800 mb-2 sm:mb-0">Condições Atuais em <span id="cityName" class="text-blue-600"></span></h2>
                <button id="talkToAIButton" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out self-start sm:self-center">
                    <i class="fas fa-brain mr-2"></i>Conversar com IA
                </button>
            </div>
            <div id="weatherSpinner" class="text-center py-4"><div class="loader"></div> Carregando dados do clima...</div>
            <div id="weatherError" class="text-red-500 text-center hidden p-4 bg-red-50 rounded-md"></div>
            
            <div id="activeWeatherAlertsContainer" class="mb-4 hidden">
                <h3 class="text-xl font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Alertas Climáticos Ativos</h3>
                <div id="activeWeatherAlerts" class="space-y-2"></div>
            </div>

            <div id="weatherData" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg shadow">
                    <h3 class="font-medium text-blue-700"><i class="fas fa-thermometer-half mr-2 text-blue-500"></i>Temperatura</h3>
                    <p class="text-3xl font-bold text-blue-900"><span id="temp">--</span>°C</p>
                    <p class="text-sm text-blue-600">Sensação: <span id="feels_like">--</span>°C</p>
                    <p class="text-sm text-blue-600">Min: <span id="temp_min">--</span>°C / Max: <span id="temp_max">--</span>°C</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg shadow">
                    <h3 class="font-medium text-green-700"><i class="fas fa-wind mr-2 text-green-500"></i>Vento</h3>
                    <p class="text-xl font-bold text-green-900"><span id="wind_speed">--</span> km/h</p>
                    <p class="text-sm text-green-600">Direção: <span id="wind_deg">--</span></p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg shadow">
                    <h3 class="font-medium text-yellow-700"><i class="fas fa-tint mr-2 text-yellow-500"></i>Umidade</h3>
                    <p class="text-xl font-bold text-yellow-900"><span id="humidity">--</span>%</p>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg shadow">
                    <h3 class="font-medium text-indigo-700"><i class="fas fa-tachometer-alt mr-2 text-indigo-500"></i>Pressão</h3>
                    <p class="text-xl font-bold text-indigo-900"><span id="pressure">--</span> hPa</p>
                </div>
                <div class="bg-cyan-50 p-4 rounded-lg shadow">
                    <h3 class="font-medium text-cyan-700"><i class="fas fa-eye mr-2 text-cyan-500"></i>Visibilidade</h3>
                    <p class="text-xl font-bold text-cyan-900"><span id="visibility">--</span> km</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow">
                    <h3 class="font-medium text-gray-700"><i class="fas fa-cloud-sun mr-2 text-gray-500"></i>Condição Geral</h3>
                    <p class="text-xl font-bold text-gray-900 capitalize" id="weather_description">--</p>
                    <img id="weather_icon" src="" alt="Ícone do tempo" class="mx-auto h-12 w-12">
                </div>
            </div>
        </section>
        
        <section id="qualidade_ar_section" class="container-card hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800"><i class="fas fa-smog mr-2 text-indigo-500"></i>Qualidade do Ar em <span id="airQualityCityName" class="text-indigo-600"></span></h2>
            <div id="airQualitySpinner" class="text-center py-4"><div class="loader"></div> Carregando dados de qualidade do ar...</div>
            <div id="airQualityError" class="text-red-500 text-center hidden p-4 bg-red-50 rounded-md"></div>
            <div id="airQualityData" class="hidden">
                <div id="aqiCard" class="aqi-card mb-4">
                    <p class="text-lg font-medium">Índice de Qualidade do Ar (IQA)</p>
                    <p class="text-4xl font-bold"><span id="air_quality_index">--</span></p>
                    <p class="text-xl"><span id="air_quality_text">--</span></p>
                </div>
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Componentes Poluentes (µg/m³):</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 text-sm">
                    <div class="bg-gray-100 p-3 rounded"><strong>CO:</strong> <span id="co">--</span></div>
                    <div class="bg-gray-100 p-3 rounded"><strong>NO:</strong> <span id="no">--</span></div>
                    <div class="bg-gray-100 p-3 rounded"><strong>NO<sub>2</sub>:</strong> <span id="no2">--</span></div>
                    <div class="bg-gray-100 p-3 rounded"><strong>O<sub>3</sub>:</strong> <span id="o3">--</span></div>
                    <div class="bg-gray-100 p-3 rounded"><strong>SO<sub>2</sub>:</strong> <span id="so2">--</span></div>
                    <div class="bg-gray-100 p-3 rounded"><strong>PM<sub>2.5</sub>:</strong> <span id="pm2_5">--</span></div>
                    <div class="bg-gray-100 p-3 rounded"><strong>PM<sub>10</sub>:</strong> <span id="pm10">--</span></div>
                    <div class="bg-gray-100 p-3 rounded"><strong>NH<sub>3</sub>:</strong> <span id="nh3">--</span></div>
                </div>
            </div>
        </section>

        <section id="forecast" class="container-card hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Previsão para os Próximos 5 Dias</h2>
            <div id="forecastSpinner" class="text-center py-4"><div class="loader"></div> Carregando previsão...</div>
            <div id="forecastError" class="text-red-500 text-center hidden p-4 bg-red-50 rounded-md"></div>
            <div id="forecastData" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
            </div>
        </section>

        <section id="mapa" class="container-card hidden">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">Mapa Ambiental</h2>
            <div class="mb-3 flex flex-wrap gap-2">
                <button id="mapLayerDefault" class="map-layer-btn bg-blue-500 text-white py-1 px-3 rounded-full text-sm">Mapa Padrão</button>
                <button id="mapLayerTemp" class="map-layer-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-full text-sm">Temperatura</button>
                <button id="mapLayerWind" class="map-layer-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-full text-sm">Vento</button>
                <button id="mapLayerPrecipitation" class="map-layer-btn bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-full text-sm">Precipitação</button>
            </div>
            <div id="map"></div>
        </section>

        <section id="ia" class="container-card">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800"> <i class="fas fa-robot mr-2 text-purple-500"></i>Assistente Virtual</h2>
            <div id="aiChatContainer" class="h-96 flex flex-col border border-gray-300 rounded-lg">
                <div id="aiChatHistory" class="flex-grow p-4 overflow-y-auto bg-white rounded-t-lg">
                     <div class="message message-bot">Olá! Sou o assistente virtual do RSAlerta. Como posso ajudar você hoje sobre o clima no Rio Grande do Sul?</div>
                </div>
                <div class="p-4 border-t border-gray-300 bg-gray-50 rounded-b-lg">
                    <div class="flex gap-2">
                        <input type="text" id="aiChatInput" placeholder="Pergunte sobre o clima, enchentes, etc." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button id="aiChatSendButton" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out">
                            <i class="fas fa-paper-plane mr-1"></i> Enviar
                        </button>
                    </div>
                    <div id="aiSpinner" class="text-sm mt-2 text-purple-600 hidden"><div class="loader !border-purple-500 !border-t-transparent"></div>A IA está pensando...</div>
                </div>
            </div>
        </section>

        <section id="datetime" class="container-card">
            <h2 class="text-xl font-semibold mb-2 text-gray-800"><i class="fas fa-clock mr-2 text-blue-500"></i>Data e Hora Atuais</h2>
            <p id="currentDateTime" class="text-lg text-gray-700">Carregando...</p>
        </section>

        <section id="alertas" class="container-card">
            <h2 class="text-xl font-semibold mb-2 text-gray-800"><i class="fas fa-triangle-exclamation mr-2 text-red-500"></i>Alertas Gerais</h2>
            <div id="generalAlertsContent">
                <p class="text-gray-700">Fique atento aos comunicados da Defesa Civil do RS. Alertas específicos para a cidade pesquisada (se disponíveis via OpenWeatherMap) aparecerão na seção "Condições Atuais".</p>
                <a href="https://www.defesacivil.rs.gov.br/inicial" target="_blank" class="text-blue-500 hover:underline">Acessar Defesa Civil RS</a>
            </div>
        </section>

        <section id="links" class="container-card">
            <h2 class="text-xl font-semibold mb-3 text-gray-800"><i class="fas fa-link mr-2 text-green-500"></i>Links Úteis</h2>
            <ul class="space-y-2">
                <li><a href="https://www.defesacivil.rs.gov.br/inicial" target="_blank" class="flex items-center p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150"><i class="fas fa-cloud-sun-rain mr-3 text-lg text-blue-500"></i>Alertas de mau tempo (Defesa Civil RS)</a></li>
                <li><a href="https://www.gov.br/pt-br/servicos/solicitar-cadastro-para-recebimento-de-avisos-e-alertas-de-desastres" target="_blank" class="flex items-center p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150"><i class="fas fa-mobile-alt mr-3 text-lg text-blue-500"></i>Cadastrar para receber avisos (Gov.br)</a></li>
                <li><a href="https://portal.inmet.gov.br/" target="_blank" class="flex items-center p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150"><i class="fas fa-chart-line mr-3 text-lg text-blue-500"></i>Portal INMET</a></li>
            </ul>
        </section>

        <section class="container-card">
            <h2 class="text-xl font-semibold mb-3 text-gray-800"><i class="fas fa-phone-volume mr-2 text-orange-500"></i>Emergência e Prevenção</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-medium mb-2 text-gray-700">Contatos de Emergência:</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <li>Defesa Civil: <strong>199</strong></li>
                        <li>Corpo de Bombeiros: <strong>193</strong></li>
                        <li>SAMU: <strong>192</strong></li>
                        <li>Polícia Militar: <strong>190</strong></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-medium mb-2 text-gray-700">Em caso de enchentes/alagamentos:</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <li>Evite áreas de risco e não atravesse águas de enchente.</li>
                        <li>Desligue a energia elétrica e o gás.</li>
                        <li>Abrigue-se em locais seguros e elevados.</li>
                        <li>Tenha um kit de emergência com água, alimentos, remédios e lanterna.</li>
                        <li>Acompanhe os alertas oficiais.</li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="container-card">
            <h2 class="text-xl font-semibold mb-3 text-gray-800"><i class="fas fa-leaf mr-2 text-teal-500"></i>Dicas de Sustentabilidade</h2>
            <ul class="list-disc list-inside space-y-1 text-gray-600">
                <li>Economize água e energia.</li>
                <li>Separe o lixo para reciclagem.</li>
                <li>Use transporte público, bicicleta ou caminhe sempre que possível.</li>
                <li>Plante árvores e cuide de áreas verdes.</li>
                <li>Evite o desperdício de alimentos.</li>
                <li>Informe-se sobre práticas sustentáveis na sua comunidade.</li>
            </ul>
        </section>

        <section class="container-card">
            <h2 class="text-xl font-semibold mb-3 text-gray-800"><i class="fas fa-newspaper mr-2 text-cyan-500"></i>Notícias Climáticas e Ambientais (RS)</h2>
            <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-3">
                <a href="https://g1.globo.com/rs/rio-grande-do-sul/" target="_blank" class="block p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150 text-center font-medium text-blue-600">G1 RS</a>
                <a href="https://www.correiodopovo.com.br/" target="_blank" class="block p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150 text-center font-medium text-blue-600">Correio do Povo</a>
                <a href="https://www.sul21.com.br/ultimas-noticias-do-sul21/meio-ambiente/" target="_blank" class="block p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150 text-center font-medium text-blue-600">Sul21 (Meio Ambiente)</a>
                <a href="https://gauchazh.clicrbs.com.br/clima/" target="_blank" class="block p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150 text-center font-medium text-blue-600">GaúchaZH Clima</a>
                <a href="https://metsul.com/" target="_blank" class="block p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150 text-center font-medium text-blue-600">MetSul Meteorologia</a>
                 <a href="https://www.estado.rs.gov.br/governo-lanca-plano-de-adaptacao-e-resiliencia-climatica" target="_blank" class="block p-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-150 text-center font-medium text-blue-600">Notícias Governo RS (Clima)</a>
            </div>
        </section>

        <section class="container-card">
            <h2 class="text-2xl font-semibold mb-6 text-center text-gray-800"><i class="fas fa-chart-pie mr-2 text-lime-500"></i>Indicadores Ambientais do Rio Grande do Sul</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="indicator-item">
                    <h4><i class="fas fa-tree mr-2"></i>Cobertura Florestal Nativa</h4>
                    <p class="text-2xl font-bold my-2">~6,3% do território</p>
                    <p>Cerca de 1,78 milhão de hectares de matas nativas, incluindo formações florestais e campestres.</p>
                    <p class="source">Fonte: MapBiomas Brasil (Dados de 2022)</p>
                </div>
                <div class="indicator-item">
                    <h4><i class="fas fa-water mr-2"></i>Qualidade dos Recursos Hídricos</h4>
                    <p class="text-2xl font-bold my-2">~60% Boa/Ótima</p>
                    <p>Dos pontos monitorados em rios e lagos, aproximadamente 60% apresentaram condição boa ou ótima para o Índice de Qualidade da Água (IQA).</p>
                    <p class="source">Fonte: FEPAM (Relatório de Qualidade da Água 2023)</p>
                </div>
                <div class="indicator-item">
                    <h4><i class="fas fa-shield-alt mr-2"></i>Áreas Protegidas</h4>
                    <p class="text-2xl font-bold my-2">+25 Unidades</p>
                    <p>O estado conta com mais de 25 Unidades de Conservação (UCs) estaduais e federais, além de Reservas Particulares do Patrimônio Natural (RPPNs).</p>
                    <p class="source">Fontes: SEMA-RS, ICMBio</p>
                </div>
                <div class="indicator-item">
                    <h4><i class="fas fa-paw mr-2"></i>Espécies da Fauna Ameaçadas</h4>
                    <p class="text-2xl font-bold my-2">136 espécies</p>
                    <p>Número de espécies da fauna oficialmente listadas como ameaçadas de extinção no Rio Grande do Sul.</p>
                    <p class="source">Fonte: SEMA-RS (Decreto Estadual nº 56.697/2022)</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-gray-300 py-12 mt-8">
        <div class="container mx-auto px-4 text-center md:text-left">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-lg font-semibold text-white mb-3">Sobre o RSAlerta</h3>
                    <p class="text-sm">O RSAlerta é um projeto desenvolvido para a feira de ciências de 2025, com o objetivo de fornecer informações climáticas e ambientais para o Rio Grande do Sul, promovendo a sustentabilidade e a prevenção de desastres.</p>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-3">Desenvolvedores</h3>
                    <ul class="text-sm space-y-1">
                        <li>Elias - Desenvolvedor Principal</li>
                        <li>Laísa - Colaboradora</li>
                        <li>Richard - Colaborador</li>
                        <li>Guilherme - Colaborador</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-white mb-3">Fontes de Dados</h3>
                    <ul class="text-sm space-y-1">
                        <li>OpenWeatherMap API</li>
                        <li>OpenAI API</li>
                        <li>INMET - Instituto Nacional de Meteorologia</li>
                        <li>Defesa Civil do Rio Grande do Sul</li>
                        <li>LeafletJS, TailwindCSS, Font Awesome</li>
                        <li>MapBiomas Brasil, FEPAM, SEMA-RS, ICMBio</li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-sm text-center">
                <p>&copy; 2025 RSAlerta - Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // --- Configurações ---
        const OPENWEATHER_API_KEY = "87b42475468c3ba9298cf245b2fa9379";
        const OPENAI_API_KEY = "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";
        const OPENAI_MODEL = "gpt-4.1-nano-2025-04-14"; // Modelo conforme solicitado


        // --- Elementos DOM ---
        const citySearchInput = document.getElementById('citySearchInput');
        const searchCityButton = document.getElementById('searchCityButton');
        const searchResultsDiv = document.getElementById('searchResults');
        const cityPresetButtons = document.querySelectorAll('.city-preset-btn');

        const climaSection = document.getElementById('clima');
        const cityNameEl = document.getElementById('cityName');
        const tempEl = document.getElementById('temp');
        const feelsLikeEl = document.getElementById('feels_like');
        const tempMinEl = document.getElementById('temp_min');
        const tempMaxEl = document.getElementById('temp_max');
        const windSpeedEl = document.getElementById('wind_speed');
        const windDegEl = document.getElementById('wind_deg');
        const humidityEl = document.getElementById('humidity');
        const pressureEl = document.getElementById('pressure');
        const visibilityEl = document.getElementById('visibility');
        const weatherDescriptionEl = document.getElementById('weather_description');
        const weatherIconEl = document.getElementById('weather_icon');
        const weatherSpinner = document.getElementById('weatherSpinner');
        const weatherError = document.getElementById('weatherError');
        const weatherDataContainer = document.getElementById('weatherData');
        
        const activeWeatherAlertsContainer = document.getElementById('activeWeatherAlertsContainer');
        const activeWeatherAlertsDiv = document.getElementById('activeWeatherAlerts');

        const qualidadeArSection = document.getElementById('qualidade_ar_section');
        const airQualityCityNameEl = document.getElementById('airQualityCityName');
        const airQualitySpinner = document.getElementById('airQualitySpinner');
        const airQualityError = document.getElementById('airQualityError');
        const airQualityDataContainer = document.getElementById('airQualityData');
        const aqiCardEl = document.getElementById('aqiCard');
        const airQualityIndexEl = document.getElementById('air_quality_index');
        const airQualityTextEl = document.getElementById('air_quality_text');
        const coEl = document.getElementById('co');
        const noEl = document.getElementById('no');
        const no2El = document.getElementById('no2');
        const o3El = document.getElementById('o3');
        const so2El = document.getElementById('so2');
        const pm25El = document.getElementById('pm2_5');
        const pm10El = document.getElementById('pm10');
        const nh3El = document.getElementById('nh3');

        const forecastSection = document.getElementById('forecast');
        const forecastDataContainer = document.getElementById('forecastData');
        const forecastSpinner = document.getElementById('forecastSpinner');
        const forecastError = document.getElementById('forecastError');

        const mapaSection = document.getElementById('mapa');
        const mapElement = document.getElementById('map');
        let map; 
        let currentMarker;
        let weatherLayers = {};

        const aiChatContainer = document.getElementById('aiChatContainer');
        const aiChatHistory = document.getElementById('aiChatHistory');
        const aiChatInput = document.getElementById('aiChatInput');
        const aiChatSendButton = document.getElementById('aiChatSendButton');
        const aiSpinner = document.getElementById('aiSpinner');
        const talkToAIButton = document.getElementById('talkToAIButton');

        const currentDateTimeEl = document.getElementById('currentDateTime');
        
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const mobileMenu = document.getElementById('mobileMenu');

        // --- Estado da Aplicação ---
        let currentWeatherData = null;
        let currentForecastData = null;
        let currentAirQualityData = null;
        let currentCityName = "";
        let currentLat = null;
        let currentLon = null;
        let aiConversationHistory = [
            { role: "system", content: "Você é o assistente virtual do RSAlerta. Responda de forma resumida e em texto corrido, a menos que uma lista seja mais apropriada. Seja gentil e amigável. Você tem acesso a informações climáticas atuais e futuras, data e hora. Use essas informações para enriquecer suas respostas sobre o clima no Rio Grande do Sul." }
        ];

        // --- Funções ---
        
        // Mobile Menu
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        document.querySelectorAll('#mobileMenu a, nav a[href^="#"]').forEach(link => {
            link.addEventListener('click', (e) => {
                if (link.closest('#mobileMenu')) mobileMenu.classList.add('hidden');
                const targetId = link.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    e.preventDefault();
                    targetElement.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Busca de Cidades
        async function searchCity(cityNameQuery) {
            searchResultsDiv.innerHTML = `<div class="text-sm text-gray-600"><div class="loader !border-blue-500 !border-t-transparent"></div> Buscando cidades...</div>`;
            climaSection.classList.add('hidden');
            qualidadeArSection.classList.add('hidden');
            forecastSection.classList.add('hidden');
            mapaSection.classList.add('hidden');
            try {
                const response = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(cityNameQuery)}&limit=5&appid=${OPENWEATHER_API_KEY}`);
                if (!response.ok) throw new Error(`Erro na API de geocodificação: ${response.statusText}`);
                const cities = await response.json();

                if (cities.length === 0) {
                    searchResultsDiv.innerHTML = `<p class="text-red-500">Nenhuma cidade encontrada para "${cityNameQuery}". Tente ser mais específico (ex: "Sarandi, RS" ou "Porto Alegre, BR").</p>`;
                    return;
                }

                let resultsHtml = `<p class="text-sm text-gray-700 mb-2">Resultados para "${cityNameQuery}":</p><div class="space-y-1">`;
                cities.forEach(city => {
                    resultsHtml += `
                        <button class="select-city-btn block w-full text-left p-2 bg-gray-50 hover:bg-gray-100 rounded-md text-sm" 
                                data-name="${city.name}" 
                                data-lat="${city.lat}" 
                                data-lon="${city.lon}"
                                data-country="${city.country}"
                                data-state="${city.state || ''}">
                            ${city.name}, ${city.state || ''} (${city.country})
                        </button>`;
                });
                resultsHtml += `</div>`;
                searchResultsDiv.innerHTML = resultsHtml;

                document.querySelectorAll('.select-city-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        currentCityName = btn.dataset.name;
                        currentLat = parseFloat(btn.dataset.lat);
                        currentLon = parseFloat(btn.dataset.lon);
                        
                        searchResultsDiv.innerHTML = ''; 
                        citySearchInput.value = `${currentCityName}${btn.dataset.state ? ', ' + btn.dataset.state : ''}`;

                        climaSection.classList.remove('hidden');
                        qualidadeArSection.classList.remove('hidden');
                        forecastSection.classList.remove('hidden');
                        mapaSection.classList.remove('hidden');
                        
                        await fetchAllCityData(currentLat, currentLon, currentCityName);
                    });
                });

            } catch (error) {
                console.error("Erro ao buscar cidade:", error);
                searchResultsDiv.innerHTML = `<p class="text-red-500">Erro ao buscar cidades. Verifique sua conexão ou a API Key. (${error.message})</p>`;
            }
        }
        
        async function fetchAllCityData(lat, lon, name) {
            await fetchWeatherData(lat, lon, name);
            await fetchAirQualityData(lat, lon, name);
            await fetchForecastData(lat, lon);
            updateMapLocation(lat, lon, name);
        }


        searchCityButton.addEventListener('click', () => {
            const city = citySearchInput.value.trim();
            if (city) searchCity(city);
        });
        citySearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const city = citySearchInput.value.trim();
                if (city) searchCity(city);
            }
        });

        cityPresetButtons.forEach(button => {
            button.addEventListener('click', () => {
                const cityQuery = button.dataset.city;
                citySearchInput.value = cityQuery; 
                searchCity(cityQuery); 
            });
        });

        // Dados Climáticos
        async function fetchWeatherData(lat, lon, name) {
            weatherSpinner.classList.remove('hidden');
            weatherError.classList.add('hidden');
            weatherDataContainer.classList.add('hidden');
            activeWeatherAlertsContainer.classList.add('hidden');
            activeWeatherAlertsDiv.innerHTML = '';

            try {
                const weatherResponse = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=pt_br`);
                if (!weatherResponse.ok) throw new Error(`Weather API Error: ${weatherResponse.statusText}`);
                const weather = await weatherResponse.json();
                currentWeatherData = weather;
                updateWeatherUI(weather, name);
                weatherDataContainer.classList.remove('hidden');

                // Fetch alerts using OneCall API (v3.0 might require subscription for some parts)
                try {
                    // Note: 'alerts' are often part of the OneCall API, not always in /weather.
                    // The OneCall API (data/3.0/onecall) is generally better for alerts.
                    // Excluding parts we don't need to optimize the call.
                    const oneCallResponse = await fetch(`https://api.openweathermap.org/data/3.0/onecall?lat=${lat}&lon=${lon}&exclude=minutely,hourly,daily,current&appid=${OPENWEATHER_API_KEY}&units=metric&lang=pt_br`);
                    if (oneCallResponse.ok) {
                        const oneCallData = await oneCallResponse.json();
                        if (oneCallData.alerts && oneCallData.alerts.length > 0) {
                            displayWeatherAlerts(oneCallData.alerts);
                        } else {
                           activeWeatherAlertsContainer.classList.add('hidden');
                        }
                    } else {
                        console.warn("OneCall API for alerts failed or returned no alerts. Status:", oneCallResponse.status);
                        activeWeatherAlertsContainer.classList.add('hidden');
                    }
                } catch (oneCallError) {
                    console.warn("Error fetching OneCall API for alerts:", oneCallError.message);
                    activeWeatherAlertsContainer.classList.add('hidden');
                }

            } catch (error) {
                console.error("Erro ao buscar dados climáticos:", error);
                weatherError.textContent = `Erro ao carregar dados do clima para ${name}. (${error.message})`;
                weatherError.classList.remove('hidden');
                currentWeatherData = null;
            } finally {
                weatherSpinner.classList.add('hidden');
            }
        }
        
        function displayWeatherAlerts(alerts) {
            let alertsHtml = "";
            alerts.forEach(alert => {
                alertsHtml += `
                    <div class="p-3 mb-2 border border-red-300 bg-red-50 rounded-md shadow-sm">
                        <h4 class="font-semibold text-red-700">${alert.event} (Fonte: ${alert.sender_name})</h4>
                        <p class="text-sm text-red-600">${alert.description}</p>
                        <p class="text-xs text-gray-500 mt-1">Início: ${new Date(alert.start * 1000).toLocaleString('pt-BR')} / Fim: ${new Date(alert.end * 1000).toLocaleString('pt-BR')}</p>
                    </div>
                `;
            });
            if (alertsHtml) {
                activeWeatherAlertsDiv.innerHTML = alertsHtml;
                activeWeatherAlertsContainer.classList.remove('hidden');
            } else {
                activeWeatherAlertsContainer.classList.add('hidden');
            }
        }

        function updateWeatherUI(weather, name) {
            cityNameEl.textContent = name;
            tempEl.textContent = Math.round(weather.main.temp);
            feelsLikeEl.textContent = Math.round(weather.main.feels_like);
            tempMinEl.textContent = Math.round(weather.main.temp_min);
            tempMaxEl.textContent = Math.round(weather.main.temp_max);
            windSpeedEl.textContent = (weather.wind.speed * 3.6).toFixed(1); // m/s to km/h
            windDegEl.textContent = `${weather.wind.deg}° (${getWindDirection(weather.wind.deg)})`;
            humidityEl.textContent = weather.main.humidity;
            pressureEl.textContent = weather.main.pressure;
            visibilityEl.textContent = weather.visibility ? (weather.visibility / 1000).toFixed(1) : '--'; // meters to km
            weatherDescriptionEl.textContent = weather.weather[0].description;
            weatherIconEl.src = `https://openweathermap.org/img/wn/${weather.weather[0].icon}@2x.png`;
            weatherIconEl.alt = weather.weather[0].description;
        }

        function getWindDirection(degrees) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }
        
        // Qualidade do Ar
        async function fetchAirQualityData(lat, lon, name) {
            airQualitySpinner.classList.remove('hidden');
            airQualityError.classList.add('hidden');
            airQualityDataContainer.classList.add('hidden');
            airQualityCityNameEl.textContent = name;

            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}`);
                if (!response.ok) throw new Error(`Air Quality API Error: ${response.statusText}`);
                const airPollution = await response.json();
                currentAirQualityData = airPollution;
                updateAirQualityUI(airPollution);
                airQualityDataContainer.classList.remove('hidden');
            } catch (error) {
                console.error("Erro ao buscar dados de qualidade do ar:", error);
                airQualityError.textContent = `Erro ao carregar dados de qualidade do ar para ${name}. (${error.message})`;
                airQualityError.classList.remove('hidden');
                currentAirQualityData = null;
            } finally {
                airQualitySpinner.classList.add('hidden');
            }
        }

        function updateAirQualityUI(airPollution) {
            if (airPollution && airPollution.list && airPollution.list.length > 0) {
                const મુખ્ય = airPollution.list[0].main; // aqi data
                const components = airPollution.list[0].components;

                airQualityIndexEl.textContent = મુખ્ય.aqi;
                const qualityText = getAirQualityText(मुख्य.aqi);
                airQualityTextEl.textContent = qualityText;

                aqiCardEl.className = 'aqi-card mb-4'; // Reset classes
                aqiCardEl.classList.add(`aqi-${मुख्य.aqi || 'unknown'}`);


                coEl.textContent = components.co.toFixed(2);
                noEl.textContent = components.no.toFixed(2);
                no2El.textContent = components.no2.toFixed(2);
                o3El.textContent = components.o3.toFixed(2);
                so2El.textContent = components.so2.toFixed(2);
                pm25El.textContent = components.pm2_5.toFixed(2);
                pm10El.textContent = components.pm10.toFixed(2);
                nh3El.textContent = components.nh3.toFixed(2);
            } else {
                airQualityIndexEl.textContent = 'N/D';
                airQualityTextEl.textContent = 'Não disponível';
                aqiCardEl.className = 'aqi-card mb-4 aqi-unknown';
                ['co', 'no', 'no2', 'o3', 'so2', 'pm2_5', 'pm10', 'nh3'].forEach(key => {
                    document.getElementById(key).textContent = '--';
                });
            }
        }
        
        function getAirQualityText(aqi) {
            // Textos podem ser mais descritivos se desejar
            if (aqi === 1) return 'Bom';
            if (aqi === 2) return 'Razoável';
            if (aqi === 3) return 'Moderado';
            if (aqi === 4) return 'Ruim';
            if (aqi === 5) return 'Muito Ruim';
            return 'Desconhecido';
        }


        // Previsão
        async function fetchForecastData(lat, lon) {
            forecastSpinner.classList.remove('hidden');
            forecastError.classList.add('hidden');
            forecastDataContainer.innerHTML = ''; 
            try {
                const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=pt_br`);
                if (!response.ok) throw new Error(`Forecast API Error: ${response.statusText}`);
                const forecast = await response.json();
                currentForecastData = forecast; 
                updateForecastUI(forecast);
            } catch (error) {
                console.error("Erro ao buscar previsão:", error);
                forecastError.textContent = `Erro ao carregar previsão. (${error.message})`;
                forecastError.classList.remove('hidden');
                currentForecastData = null;
            } finally {
                forecastSpinner.classList.add('hidden');
            }
        }

        function updateForecastUI(forecast) {
            forecastDataContainer.innerHTML = ''; 
            const dailyForecasts = {};

            forecast.list.forEach(item => {
                const date = item.dt_txt.split(' ')[0];
                if (!dailyForecasts[date]) {
                    dailyForecasts[date] = {
                        temps: [],
                        min_temps: [],
                        max_temps: [],
                        icons: [],
                        descs: []
                    };
                }
                dailyForecasts[date].temps.push(item.main.temp);
                dailyForecasts[date].min_temps.push(item.main.temp_min);
                dailyForecasts[date].max_temps.push(item.main.temp_max);
                dailyForecasts[date].icons.push(item.weather[0].icon);
                dailyForecasts[date].descs.push(item.weather[0].description);
            });
            
            let dayCount = 0;
            for (const date in dailyForecasts) {
                if (dayCount >= 5) break; 

                const dayData = dailyForecasts[date];
                const avgTemp = dayData.temps.reduce((a, b) => a + b, 0) / dayData.temps.length;
                const overallMinTemp = Math.min(...dayData.min_temps); // Min of all min_temps for the day
                const overallMaxTemp = Math.max(...dayData.max_temps); // Max of all max_temps for the day
                
                const mostFrequentIcon = getMostFrequent(dayData.icons);
                const mostFrequentDesc = getMostFrequent(dayData.descs);

                const forecastDate = new Date(date + "T00:00:00"); // Ensure correct date parsing for local timezone
                const dayName = forecastDate.toLocaleDateString('pt-BR', { weekday: 'short' });
                const formattedDate = forecastDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });

                const cardHtml = `
                    <div class="bg-white p-4 rounded-lg shadow text-center border border-gray-200">
                        <p class="font-semibold text-gray-800">${dayName}, ${formattedDate}</p>
                        <img src="https://openweathermap.org/img/wn/${mostFrequentIcon}@2x.png" alt="${mostFrequentDesc}" class="mx-auto h-16 w-16">
                        <p class="text-xl font-bold text-gray-900">${Math.round(avgTemp)}°C</p>
                        <p class="text-xs text-gray-600">Min: ${Math.round(overallMinTemp)}°C / Max: ${Math.round(overallMaxTemp)}°C</p>
                        <p class="text-sm text-gray-500 capitalize">${mostFrequentDesc}</p>
                    </div>
                `;
                forecastDataContainer.innerHTML += cardHtml;
                dayCount++;
            }
        }
        
        function getMostFrequent(arr) {
            if (!arr || arr.length === 0) return '';
            const frequencyMap = arr.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
            return Object.keys(frequencyMap).reduce((a, b) => frequencyMap[a] > frequencyMap[b] ? a : b);
        }

        // Mapa
        function initMap() {
            map = L.map(mapElement).setView([-30.0346, -51.2177], 7); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const owmAppIdQueryParam = `&appid=${OPENWEATHER_API_KEY}`;
            weatherLayers.temp = L.tileLayer(`https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?${owmAppIdQueryParam}`, { attribution: 'OpenWeatherMap' });
            weatherLayers.wind = L.tileLayer(`https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?${owmAppIdQueryParam}`, { attribution: 'OpenWeatherMap' });
            weatherLayers.precipitation = L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?${owmAppIdQueryParam}`, { attribution: 'OpenWeatherMap' });
            
            document.getElementById('mapLayerDefault').addEventListener('click', () => switchMapLayer());
            document.getElementById('mapLayerTemp').addEventListener('click', () => switchMapLayer('temp'));
            document.getElementById('mapLayerWind').addEventListener('click', () => switchMapLayer('wind'));
            document.getElementById('mapLayerPrecipitation').addEventListener('click', () => switchMapLayer('precipitation'));
        }

        let activeLayer = null;
        function switchMapLayer(layerKey) {
            if (activeLayer) {
                map.removeLayer(activeLayer);
                activeLayer = null;
            }
            if (layerKey && weatherLayers[layerKey]) {
                activeLayer = weatherLayers[layerKey];
                map.addLayer(activeLayer);
            }
            document.querySelectorAll('.map-layer-btn').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });
            const activeBtnId = layerKey ? `mapLayer${layerKey.charAt(0).toUpperCase() + layerKey.slice(1)}` : 'mapLayerDefault';
            document.getElementById(activeBtnId).classList.add('bg-blue-500', 'text-white');
            document.getElementById(activeBtnId).classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
        }

        function updateMapLocation(lat, lon, name) {
            if (map) {
                map.setView([lat, lon], 10);
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                currentMarker = L.marker([lat, lon]).addTo(map)
                    .bindPopup(`<b>${name}</b>`)
                    .openPopup();
            }
        }
        
        // IA Chat
        talkToAIButton.addEventListener('click', () => {
            document.getElementById('ia').scrollIntoView({ behavior: 'smooth' });
            aiChatInput.focus();
        });

        aiChatSendButton.addEventListener('click', sendAiChatMessage);
        aiChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { // Send on Enter, allow Shift+Enter for new line
                e.preventDefault(); 
                sendAiChatMessage();
            }
        });

        function addMessageToChat(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'message-user' : 'message-bot');
            
            let formattedMessage = message
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");

            formattedMessage = formattedMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
            formattedMessage = formattedMessage.replace(/\*(.*?)\*/g, '<em>$1</em>');       
            formattedMessage = formattedMessage.replace(/^\s*-\s+(.*)/gm, '<li>$1</li>');
            if (formattedMessage.includes('<li>')) {
                formattedMessage = '<ul>' + formattedMessage.replace(/<\/li>\s*<li>/g, '</li><li>') + '</ul>';
            }
            formattedMessage = formattedMessage.replace(/\n/g, '<br>');

            messageDiv.innerHTML = formattedMessage;
            aiChatHistory.appendChild(messageDiv);
            aiChatHistory.scrollTop = aiChatHistory.scrollHeight;
        }

        async function sendAiChatMessage() {
            const userInput = aiChatInput.value.trim();
            if (!userInput) return;

            addMessageToChat(userInput, 'user');
            aiChatInput.value = '';
            aiSpinner.classList.remove('hidden');
            aiChatSendButton.disabled = true;

            let contextForAI = `Data e hora atuais: ${new Date().toLocaleString('pt-BR')}.`;
            if (currentCityName && currentWeatherData) {
                contextForAI += ` Clima atual em ${currentCityName}: ${currentWeatherData.weather[0].description}, Temperatura: ${Math.round(currentWeatherData.main.temp)}°C, Sensação: ${Math.round(currentWeatherData.main.feels_like)}°C.`;
            }
            if (currentCityName && currentForecastData && currentForecastData.list.length > 0) {
                const nextForecast = currentForecastData.list[0];
                contextForAI += ` Próxima previsão para ${currentCityName} (${new Date(nextForecast.dt*1000).toLocaleDateString('pt-BR')}): ${nextForecast.weather[0].description}, Temp. Média: ${Math.round(nextForecast.main.temp)}°C.`;
            }
             if (currentCityName && currentAirQualityData && currentAirQualityData.list.length > 0) {
                const aqiData = currentAirQualityData.list[0].main;
                contextForAI += ` Qualidade do ar em ${currentCityName}: ${getAirQualityText(aqiData.aqi)} (IQA: ${aqiData.aqi}).`;
            }
            
            aiConversationHistory.push({ role: "user", content: `${userInput} (Contexto adicional: ${contextForAI})` });

            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: OPENAI_MODEL,
                        messages: aiConversationHistory,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Erro da API OpenAI:", errorData);
                    let errorMessage = `Erro ${response.status}: ${response.statusText}.`;
                    if (errorData && errorData.error && errorData.error.message) {
                        errorMessage += ` Detalhe: ${errorData.error.message}`;
                         if (errorData.error.code === 'invalid_api_key') {
                             errorMessage += " Por favor, verifique se a API Key da OpenAI está correta e ativa.";
                        } else if (errorData.error.type === 'insufficient_quota') {
                            errorMessage += " Você excedeu sua cota da OpenAI ou não possui créditos suficientes.";
                        } else if (errorData.error.message.includes("model_not_found")) {
                            errorMessage += ` O modelo '${OPENAI_MODEL}' não foi encontrado ou você não tem acesso a ele. Tente um modelo padrão como 'gpt-3.5-turbo'.`;
                        }
                    }
                    addMessageToChat(`Desculpe, não consegui processar sua solicitação. ${errorMessage}`, 'bot');
                    aiConversationHistory.pop(); 
                    return;
                }

                const data = await response.json();
                if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                    const botResponse = data.choices[0].message.content.trim();
                    addMessageToChat(botResponse, 'bot');
                    aiConversationHistory.push({ role: "assistant", content: botResponse });
                } else {
                     addMessageToChat("Desculpe, não recebi uma resposta válida da IA. Verifique o console para mais detalhes.", 'bot');
                     console.log("Resposta da IA incompleta:", data);
                }

            } catch (error) {
                console.error("Erro ao contatar OpenAI:", error);
                addMessageToChat(`Erro de conexão com a IA. Verifique o console para detalhes. (${error.message})`, 'bot');
                aiConversationHistory.pop(); 
            } finally {
                aiSpinner.classList.add('hidden');
                aiChatSendButton.disabled = false;
                aiChatInput.focus();
            }
        }

        // Data e Hora
        function updateDateTime() {
            const now = new Date();
            currentDateTimeEl.textContent = now.toLocaleString('pt-BR', { dateStyle: 'full', timeStyle: 'medium' });
        }


        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            updateDateTime();
            setInterval(updateDateTime, 1000); 

            // Carrega Porto Alegre por padrão
            citySearchInput.value = "Porto Alegre";
            searchCity("Porto Alegre");
        });

    </script>
</body>
</html>
